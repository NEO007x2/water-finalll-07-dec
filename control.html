<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control Panel - Robot Control</title>
  <style>
    /* ===== CSS Variables ===== */
    :root {
      --background: #0a0a0a;
      --foreground: #fafafa;
      --card: #141414;
      --card-foreground: #fafafa;
      --primary: #3b82f6;
      --primary-foreground: #ffffff;
      --secondary: #1f1f1f;
      --muted: #262626;
      --muted-foreground: #a3a3a3;
      --border: #262626;
      --radius: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background);
      color: var(--foreground);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ===== Header ===== */
    .header {
      height: 56px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      background-color: var(--background);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .header-icon {
      width: 24px;
      height: 24px;
      color: var(--primary);
    }

    .header h1 {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .btn-secondary {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background-color: var(--secondary);
      color: var(--foreground);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-secondary:hover {
      background-color: var(--muted);
      transform: scale(1.02);
    }

    .btn-logout {
      padding: 0.5rem 1rem;
      background-color: transparent;
      color: var(--muted-foreground);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-logout:hover {
      background-color: var(--muted);
      color: var(--foreground);
    }

    /* ===== Main Content ===== */
    .main {
      padding: 1rem;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* ===== Cards ===== */
    .card {
      background-color: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      transition: transform 0.2s;
    }

    .card:hover {
      transform: scale(1.01);
    }

    .card-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-description {
      color: var(--muted-foreground);
      font-size: 0.875rem;
    }

    .card-content {
      padding: 1.5rem;
    }

    /* ===== Three Column Grid ===== */
    .three-column-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    @media (min-width: 1024px) {
      .three-column-grid {
        grid-template-columns: 1fr 2fr 1fr;
      }
    }

    /* Column ordering for mobile */
    .drive-card {
      order: 2;
    }

    .camera-card {
      order: 1;
    }

    .functions-card {
      order: 3;
    }

    @media (min-width: 1024px) {
      .drive-card {
        order: 1;
      }
      
      .camera-card {
        order: 2;
      }
      
      .functions-card {
        order: 3;
      }
    }

    /* ===== Drive Controls ===== */
    .drive-controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
    }

    .drive-row {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .drive-btn {
      width: 64px;
      height: 64px;
      background-color: var(--primary);
      color: var(--primary-foreground);
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .drive-btn:hover {
      background-color: #2563eb;
      transform: scale(1.05);
    }

    .drive-btn:active {
      transform: scale(0.95);
    }

    /* ===== Camera View ===== */
    .camera-view {
      aspect-ratio: 4/3;
      min-height: 300px;
      background-color: var(--muted);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    @media (min-width: 1024px) {
      .camera-view {
        min-height: 400px;
      }
    }

    .camera-placeholder {
      text-align: center;
      padding: 2rem;
    }

    .camera-icon {
      width: 64px;
      height: 64px;
      color: var(--muted-foreground);
      margin: 0 auto 1rem;
    }

    .camera-placeholder p {
      color: var(--muted-foreground);
      margin-bottom: 0.5rem;
    }

    .camera-placeholder .small {
      font-size: 0.75rem;
    }

    /* ===== Robot Functions ===== */
    .functions-list {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .function-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background-color: rgba(38, 38, 38, 0.5);
      border-radius: var(--radius);
    }

    .function-label {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .function-icon {
      width: 20px;
      height: 20px;
    }

    .function-icon.active {
      color: var(--primary);
    }

    .function-icon.inactive {
      color: var(--muted-foreground);
    }

    /* ===== Toggle Switch ===== */
    .switch {
      position: relative;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--secondary);
      border-radius: 24px;
      transition: 0.3s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: var(--foreground);
      border-radius: 50%;
      transition: 0.3s;
    }

    input:checked + .slider {
      background-color: var(--primary);
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }

    /* ===== Button ===== */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background-color: var(--primary);
      color: var(--primary-foreground);
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
    }

    .btn:hover {
      background-color: #2563eb;
      transform: scale(1.02);
    }

    .btn:active {
      transform: scale(0.98);
    }

    /* ===== Gallery ===== */
    .gallery-empty {
      text-align: center;
      color: var(--muted-foreground);
      padding: 2rem;
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    @media (min-width: 768px) {
      .gallery-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (min-width: 1024px) {
      .gallery-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .gallery-item {
      aspect-ratio: 16/9;
      background-color: var(--muted);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* ===== Toast ===== */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background-color: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem 1.5rem;
      display: none;
      flex-direction: column;
      gap: 0.25rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .toast.show {
      display: flex;
    }

    .toast-title {
      font-weight: 600;
    }

    .toast-message {
      color: var(--muted-foreground);
      font-size: 0.875rem;
    }

    /* ===== Icons ===== */
    .icon {
      display: inline-block;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <svg class="header-icon icon" viewBox="0 0 24 24">
        <path d="M12 8V4H8"/>
        <rect width="16" height="12" x="4" y="8" rx="2"/>
        <path d="M2 14h2"/><path d="M20 14h2"/>
        <path d="M15 13v2"/><path d="M9 13v2"/>
      </svg>
      <h1>Robot Control Panel</h1>
    </div>
    <div class="header-actions">
      <a href="index.html" class="btn-secondary">
        <svg class="icon" style="width: 16px; height: 16px;" viewBox="0 0 24 24">
          <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
        Home
      </a>
      <button class="btn-logout" id="logoutBtn">Logout</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <!-- Three Column Grid: Drive | Camera | Functions -->
    <div class="three-column-grid">
      <!-- LEFT - Drive Controls -->
      <div class="card drive-card">
        <div class="card-header">
          <div class="card-title">Drive Controls</div>
          <div class="card-description">Use WASD keys or click buttons</div>
        </div>
        <div class="card-content">
          <div class="drive-controls">
            <div class="drive-row">
              <button class="drive-btn" id="btnForward" data-direction="forward">
                ↑
              </button>
            </div>
            <div class="drive-row">
              <button class="drive-btn" id="btnLeft" data-direction="left">
                ←
              </button>
              <button class="drive-btn" id="btnBackward" data-direction="backward">
                ↓
              </button>
              <button class="drive-btn" id="btnRight" data-direction="right">
                →
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- CENTER - Camera View (Larger) -->
      <div class="card camera-card">
        <div class="card-header">
          <div class="card-title">
            <svg class="icon" style="width: 20px; height: 20px;" viewBox="0 0 24 24">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
            Live Camera View
          </div>
          <div class="card-description">ESP32 camera stream</div>
        </div>
        <div class="card-content">
          <div class="camera-view">
            <div class="camera-placeholder">
              <svg class="camera-icon icon" viewBox="0 0 24 24">
                <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                <circle cx="12" cy="13" r="3"/>
              </svg>
              <p>Camera stream will appear here when ESP32 is connected</p>
              <p class="small">Configure ESP32 to stream to: wss://your-stream-url</p>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT - Robot Functions -->
      <div class="card functions-card">
        <div class="card-header">
          <div class="card-title">Robot Functions</div>
          <div class="card-description">Control water and arms</div>
        </div>
        <div class="card-content">
          <div class="functions-list">
            <!-- Water Pump Toggle -->
            <div class="function-item">
              <div class="function-label">
                <svg class="function-icon inactive" id="pumpIcon" viewBox="0 0 24 24">
                  <path class="icon" d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                </svg>
                <span id="pumpLabel">Water Pump</span>
              </div>
              <label class="switch">
                <input type="checkbox" id="pumpToggle">
                <span class="slider"></span>
              </label>
            </div>

            <!-- Arms Toggle -->
            <div class="function-item">
              <div class="function-label">
                <svg class="function-icon inactive" id="armsIcon" viewBox="0 0 24 24">
                  <path class="icon" d="M12 8V4H8"/>
                  <rect class="icon" width="16" height="12" x="4" y="8" rx="2"/>
                  <path class="icon" d="M2 14h2"/>
                  <path class="icon" d="M20 14h2"/>
                  <path class="icon" d="M15 13v2"/>
                  <path class="icon" d="M9 13v2"/>
                </svg>
                <span id="armsLabel">Arms (90°)</span>
              </div>
              <label class="switch">
                <input type="checkbox" id="armsToggle">
                <span class="slider"></span>
              </label>
            </div>

            <!-- Capture Photo Button -->
            <button class="btn" id="captureBtn">
              <svg class="icon" style="width: 20px; height: 20px;" viewBox="0 0 24 24">
                <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                <circle cx="12" cy="13" r="3"/>
              </svg>
              Capture Photo
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Photo Gallery -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">Photo Gallery</div>
        <div class="card-description">Recent photos from ESP32 camera</div>
      </div>
      <div class="card-content">
        <div id="photoGallery">
          <p class="gallery-empty">No photos yet. Capture your first photo!</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span class="toast-title" id="toastTitle"></span>
    <span class="toast-message" id="toastMessage"></span>
  </div>

  <script>
    // ===== Check Authentication =====
    function checkAuth() {
      const isLoggedIn = sessionStorage.getItem('isLoggedIn');
      console.log('Checking auth, isLoggedIn:', isLoggedIn); // Debug log
      if (!isLoggedIn) {
        console.log('Not logged in, redirecting to auth.html'); // Debug log
        window.location.href = 'auth.html';
      } else {
        console.log('Logged in successfully'); // Debug log
      }
    }

    // Small delay to ensure session is set
    setTimeout(() => {
      checkAuth();
    }, 100);

    // ===== Logout =====
    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
      sessionStorage.removeItem('isLoggedIn');
      sessionStorage.removeItem('userEmail');
      showToast('Logged out', 'Redirecting to home...');
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 1000);
    });

    // ===== Toast Notification =====
    function showToast(title, message) {
      const toast = document.getElementById('toast');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');

      toastTitle.textContent = title;
      toastMessage.textContent = message;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ===== Drive Controls =====
    const driveButtons = document.querySelectorAll('.drive-btn');
    driveButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const direction = btn.dataset.direction;
        showToast(`Driving ${direction}`, 'Command sent to robot');
      });
    });

    // ===== Keyboard Controls (WASD) =====
    document.addEventListener('keydown', (e) => {
      const key = e.key.toLowerCase();
      let direction = null;
      let btnId = null;

      switch (key) {
        case 'w':
          direction = 'forward';
          btnId = 'btnForward';
          break;
        case 'a':
          direction = 'left';
          btnId = 'btnLeft';
          break;
        case 's':
          direction = 'backward';
          btnId = 'btnBackward';
          break;
        case 'd':
          direction = 'right';
          btnId = 'btnRight';
          break;
      }

      if (direction) {
        showToast(`Driving ${direction}`, 'Command sent to robot');
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.style.transform = 'scale(0.95)';
          setTimeout(() => {
            btn.style.transform = '';
          }, 100);
        }
      }
    });

    // ===== Water Pump Toggle =====
    const pumpToggle = document.getElementById('pumpToggle');
    const pumpIcon = document.getElementById('pumpIcon');

    pumpToggle.addEventListener('change', () => {
      const isOn = pumpToggle.checked;
      if (isOn) {
        pumpIcon.classList.remove('inactive');
        pumpIcon.classList.add('active');
      } else {
        pumpIcon.classList.remove('active');
        pumpIcon.classList.add('inactive');
      }
      showToast(isOn ? 'Pump ON' : 'Pump OFF', isOn ? 'Water flowing' : 'Water stopped');
    });

    // ===== Arms Toggle =====
    const armsToggle = document.getElementById('armsToggle');
    const armsLabel = document.getElementById('armsLabel');
    const armsIcon = document.getElementById('armsIcon');

    armsToggle.addEventListener('change', () => {
      const isOpen = armsToggle.checked;
      armsLabel.textContent = isOpen ? 'Arms (180°)' : 'Arms (90°)';
      
      if (isOpen) {
        armsIcon.classList.remove('inactive');
        armsIcon.classList.add('active');
      } else {
        armsIcon.classList.remove('active');
        armsIcon.classList.add('inactive');
      }
      
      showToast(
        isOpen ? 'Arms Open (180°)' : 'Arms Closed (90°)',
        isOpen ? 'Pipes in open position' : 'Pipes in closed position'
      );
    });

    // ===== Capture Photo =====
    const captureBtn = document.getElementById('captureBtn');
    const photoGallery = document.getElementById('photoGallery');
    let photos = [];

    function renderGallery() {
      if (photos.length === 0) {
        photoGallery.innerHTML = '<p class="gallery-empty">No photos yet. Capture your first photo!</p>';
      } else {
        photoGallery.innerHTML = `
          <div class="gallery-grid">
            ${photos.map(photo => `
              <div class="gallery-item">
                <img src="${photo.url}" alt="Captured at ${photo.date}">
              </div>
            `).join('')}
          </div>
        `;
      }
    }

    captureBtn.addEventListener('click', () => {
      showToast('Capturing photo', 'Requesting photo from ESP32...');

      // Simulate photo capture
      setTimeout(() => {
        const newPhoto = {
          url: `https://picsum.photos/800/600?random=${Date.now()}`,
          date: new Date().toLocaleString()
        };
        photos.unshift(newPhoto);
        renderGallery();
        showToast('Photo captured!', 'Photo saved to gallery');
      }, 500);
    });

    // Initialize
    renderGallery();
  </script>
</body>
</html>